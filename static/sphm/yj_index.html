<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>智能运营SOAM平台2.0</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">  
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
    <link href="css/style.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="css/jquery.page.css" type="text/css">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/jquery.page.js"></script>
	<script type="text/javascript" src="laydate/laydate.js"></script>
    <script src="layer/layer.js" type="text/javascript"></script>
    <script src="js/jquery.form.js" type="text/javascript"></script>
    <script src="js/full-validator.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/echarts.min.js"></script>
    <script src="js/mychart.js" type="text/javascript"></script>
    <style>
    .table_2 .grid td{min-width:100px;}
    </style>
</head>
<body>
    <div class="container yj_index">
		<div class="row_1 clearfix">
			<div class="chart_1" id="chart_1">
			</div>
			<div class="chart_2" id="chart_2">
				
			</div>
			<div class="cms">
				<div class="logo"><p>CMS监测报告</p></div>
			</div>
			<div class="btn_b">
				<a href='javascript:;' class="a1 active">审核派工</a><a href='javascript:;' class="a2">执行结果</a>
			</div>
		</div>
		<div class="row_3 clearfix" style="padding:10px 0px;background-color: #3A414C;">
			<div class="table_1">
				<a href='javascript:;' class="ml15">审核回退</a>
				<a href='javascript:;' class="right">开始派工</a>
				<a href='javascript:;' class="right mr15">新增预警</a>
			</div>
			<div class="table_3">
				<a href='javascript:;' class="right">结项</a>
			</div>
			<div class="table_2">
				<a href='manaport.html?tab=2'>管理报告</a>
				<a href='javascript:;' class="right">提交预警</a>
			</div>
		</div>
		<div class="row_2 clearfix">
			<div class="table_1">
                <div style="height:420px;background: url(images/vga1.png) repeat;border:1px solid #ACAEB1;margin-top: 15px;">
                    <table class="grid" border="0" cellpadding="0" cellspacing="0" style="border:0px;margin: 0px;">
                        <thead>
                            <tr>
                                <td style="width:50px;">&nbsp;</td>
                                <td>预警时间</td>
                                <td>区域</td>
                                <td>风场</td>
                                <td>机组</td>
                                <td>隐患点</td>
                                <td>等级</td>
                                <td>处理方案</td>
                                <td>状态</td>
                                <td>流程</td>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    </div>
                <div id="page" class="pt15 page_1"></div>
            </div>
			<div class="table_2">
                <div style="height:420px;background: url(images/vga1.png) repeat;border:1px solid #ACAEB1;margin-top: 15px;">
                    <table class="grid" border="0" cellpadding="0" cellspacing="0" style="border:0px;margin: 0px;">
                        <thead>
                            <tr>
                                <td>上传时间</td>
                                <td>状态</td>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
				<div id="page_2" class="pt15"></div>
			</div>
		</div>
    </div>
	<div class="dialog yj_form" id="dialog_1">
        <div class="opacity" style="z-index:9991;"></div>
        <div class="content" style="width:600px;margin-left:-300px;z-index:9992;">
            <a class="close"></a>
            <h1>审核回退</h1>
			<form id="ht_form">
				<dl class="clearfix">
					<dt>回退理由</dt>
					<dd><select id="reason" name="reason" datatype="Require" msg="请选择回退理由">
						<option value="">请选择</option>
						<option value="数据不准确">数据不准确</option>
						<option value="轻微故障，暂不处理">轻微故障，暂不处理</option>
						<option value="预警过晚，已完成处理">预警过晚，已完成处理</option>
					</select></dd>
				</dl>
				<dl class="clearfix">
					<dt>备注</dt>
					<dd><textarea name="ht_remark" id="ht_remark"></textarea></dd>
				</dl>
				<div class="btn">
					<button type="button" class="cancle" for="dialog_1">取消</button>
					<button type="button" class="ml15 submitBtn" onclick="huitui()">确认</button>
				</div>
			</form>
        </div>
    </div>
	<div class="dialog yj_form" id="dialog_2">
        <div class="opacity"></div>
        <div class="content" style="width:600px;margin-left:-300px;">
            <a class="close"></a>
            <h1>预警工单</h1>
			<form id="add_form">
				<dl class="clearfix">
					<dt><i class="red">*</i>预警来源</dt>
					<dd>
						<select id="addsource" name="addsource" datatype="Require" msg="请选择预警来源">
							<option selected="" value="">请选择</option>
						    <option value="1">巡检发现异常</option>
						    <option value="2">生产系统预警</option>
						    <option value="3">检测报告预警</option>
						</select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>区域名称</dt>
					<dd>
                        <select disabled>
                            <option value="巴盟">巴盟</option>
                        </select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt><i class="red">*</i>风场名称</dt>
					<dd>
						<select id="addwfName" name="addwfName" onchange="bindWT('#addwtName',this)" datatype="Require" msg="请选择风场名称">
							<option value="">请选择</option>
                        </select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt><i class="red">*</i>机组名称</dt>
					<dd>
						<select id="addwtName" name="addwtName" datatype="Require" msg="请选择机组名称">
							<option value="">请选择</option>
						</select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt><i class="red">*</i>隐患名称</dt>
					<dd>
						<select id="addYhd" name="addYhd" onchange="bindYhLevel(this)" datatype="Require" msg="请选择隐患名称">
							<option value="">请选择</option>
						</select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>预警级别</dt>
					<dd>
						<select id="addLevel" name="addLevel" disabled>
							<option value="1级">1级</option>
						</select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>备注</dt>
					<dd><textarea name="addremark" id="addremark" ></textarea></dd>
				</dl>
				<div class="btn">
					<button type="button" class="cancle" for="dialog_2">取消</button>
					<button type="button" class="ml15 submitBtn">安排派工</button>
				</div>
			</form>
        </div>
    </div>
	
	<div class="dialog yj_form" id="dialog_3">
        <div class="opacity" style="z-index:9991;"></div>
        <div class="content" style="width:600px;margin-left:-300px;z-index:9992;">
            <a class="close"></a>
            <h1>派工（故障告知单）</h1>
			<form id="pg_form">
                <input type="hidden" id="pg_wtid" />
				<dl class="clearfix">
					<dt>工单编号</dt>
					<dd>
                        <input type="text" class="txt" id="pg_workID" name="pg_workID" readonly="readonly" style="width: 380px;" value="" />
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>预警时间</dt>
					<dd>
                        <input type="text" class="txt" id="pg_yjTime" name="pg_yjTime" readonly="readonly" style="width: 380px;" value="" />
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>来源</dt>
					<dd>
						<select id="pg_source" name="pg_source" disabled="disabled"></select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>风场名称</dt>
					<dd>
						<select id="pg_wfName" name="pg_wfName" disabled="disabled"></select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>机组名称</dt>
					<dd>
						<select id="pg_wtName" name="pg_wtName" disabled="disabled"></select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>隐患名称</dt>
					<dd>
						<select id="pg_yhd" name="pg_yhd" disabled="disabled"></select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>预警级别</dt>
					<dd>
						<select id="pg_level" name="pg_level" disabled="disabled"></select>
					</dd>
				</dl>
				<dl class="clearfix">
					<dt>备注</dt>
					<dd><textarea name="pg_remark" id="pg_remark" ></textarea></dd>
				</dl>
				<div class="btn">
					<button type="button" class="cancle" for="dialog_3">取消</button>
					<button type="button" class="ml15 submitBtn" onclick="paigong()">提交派工</button>
				</div>
			</form>
        </div>
    </div>

	<div class="dialog yj_form" id="dialog_4">
        <div class="opacity"></div>
        <div class="content" style="width:600px;margin-left:-300px;">
            <a class="close"></a>
            <h1>提交大部件监测报告</h1>
            <form id="uploadForm">
                <dl class="clearfix">
                    <dt><i class="red">*</i>上传文件</dt>
                    <dd>
                        <input type="file" id="file" name="file" class="txt" onchange="CmsUpload(this)" style="width:380px;padding:0px;" />
                    </dd>
                </dl>
            </form>
            <form id="subform">
                <input type="hidden" id="hidfile" datatype="Require" msg="请上传文件" />
                <dl class="clearfix">
                    <dt><i class="red">*</i>选择区域</dt>
                    <dd>
                        <select id="sub_yj_area" name="sub_yj_area" disabled>
                            <option value="巴盟">巴盟</option>
                        </select>
                    </dd>
                </dl>
                <dl class="clearfix">
                    <dt><i class="red">*</i>风场名称</dt>
                    <dd>
                        <select id="subwfName" name="subwfName"></select>
                    </dd>
                </dl>
                <dl class="clearfix">
                    <dt><i class="red">*</i>预警等级</dt>
                    <dd>
                        <select id="sublevel" name="sublevel">
                            <option value="0">正常</option>
                            <option value="1">预警</option>
                            <option value="2">报警</option>
                        </select>
                    </dd>
                </dl>
                <dl class="clearfix">
                    <dt><i class="red">*</i>报告周期</dt>
                    <dd>
                        <input type="text" class="txt" id="beginDate" name="beginDate" style="width: 100px;" datatype="Require" msg="请选择报告周期开始日期" /> -
                        <input type="text" class="txt" id="endDate" name="endDate" style="width: 100px;" datatype="Require" msg="请选择报告周期结束日期" />
                    </dd>
                </dl>
                <dl class="clearfix">
                    <dt>备注</dt>
                    <dd><textarea name="subremark" id="subremark"></textarea></dd>
                </dl>
                <div class="btn">
                    <button type="button" class="cancle" for="dialog_4">取消</button>
                    <button type="button" class="ml15 submitBtn">确认</button>
                </div>
            </form>
        </div>
    </div>

	<div class="dialog gd_detail">
        <div class="opacity"></div>
        <div class="content" style="width:1000px;margin-left:-500px;">
            <a class="close"></a>
            <h1><label></label><span>结项</span><span>审核退回</span><span>开始派工</span></h1>
            <div class="scroll" style="height:600px;overflow:auto;">
				<div class="wrap">
					<label>状态</label><span></span>
					<label>流程</label><span></span>
					<label>隐患点</label><span></span>
					<label>预警等级</label><span></span>
				</div>
				<div class="wrap">
					<label>区域</label><span></span>
					<label>风电场</label><span></span>
					<label>机组</label><span></span>
					<label>预警时间</label><span></span>
				</div>
				<div class="wrap">
					<label>处理时间</label><span></span>
					<label>处理结果</label><span></span>
					<label>预警准确度</label><span class='x'>&nbsp;<p></p></span>
				</div>
				<div class="wrap">
					<label>备注</label>
					<div class="mul_text">
					</div>
				</div>
				<div class="wrap">
					<label>系统推荐处理方案</label>
					<div class="mul_text">
						
					</div>
				</div>
				<div class="wrap">
					<label>推荐专家</label>
					<div class="zj clearfix">
						<div class="item">
							<img src="images/user/1.png" />
							<h2>黄鹤</h2>
							<h3>Tel：17743115900</h3>
							<p>事业部调度工程师，2年现场维护经验，2年现场调度经验，擅长处理控制柜温度异常、变桨电机异常等预警</p>
						</div>
						<div class="item">
                            <img src="images/user/2.png" />
							<h2>王雪</h2>
							<h3>Tel：18609005230</h3>
							<p>具有十年1.5MW机组的运维技术支持经验，擅长整机运行数据的分析及故障处理指导.</p>
						</div>
						<div class="item">
                            <img src="images/user/3.png" />
							<h2>余斌</h2>
							<h3>Tel：13301152536</h3>
							<p>5年机组装配和现场机组维护经验，目前从事技术支持工作，擅长处理机组变桨、水冷、机舱系统常规变量数据异常</p>
						</div>
					</div>
				</div>
				<div class="wrap">
					<label>流程记录</label>
					<div class="liucheng">
						<div class="line"><i></i></div>
					</div>
				</div>
			</div>
        </div>
    </div>
    <div class="dialog jx_detail" id="jx_detail">
        <div class="opacity" style="z-index:9991;"></div>
        <div class="content" style="width:1000px;margin-left:-500px;z-index:9992;">
            <a class="close"></a>
            <h1></h1>
            <div class="scroll" style="height:650px;overflow:auto;padding-bottom:30px;">
                <table class="grid" border="0" cellpadding="0" cellspacing="0" style="margin-top:5px;border:0px;">
                    <thead>
                        <tr>
                            <td>预警时间</td>
                            <td>区域</td>
                            <td>风场</td>
                            <td>机组</td>
                            <td>隐患点</td>
                            <td>等级</td>
                            <td>处理方案</td>
                            <td>状态</td>
                            <td>流程</td>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <h1 style="text-align:center;margin-top:15px;">执行结果查看</h1>
                <div class="clearfix mt15" style="padding:0px 20px">
                    <div id="scroll_h" style="overflow:auto;">
                        <div style="white-space:nowrap;" class="clearfix">
                        </div>
                    </div>
                </div>
                <div class="hide">
                    <div class="d_zql clearfix">
                        <label>预警准确率</label>
                        <p><span></span></p>
                    </div>
                    <h1 style="text-align:center;margin:15px 20px 0;">结项备注</h1>
                    <div style="margin:0px 20px;"><textarea class="remark" readonly="readonly"></textarea></div>
                </div>
                <div class="btn">
                    <button type="button" class="cancle" for="jx_detail">关闭</button>
                    <button type="button" class="ml15 submitBtn">结项</button>
                </div>
            </div>
        </div>
    </div>
    <div class="dialog jx_detail" id="jx_detail_form">
        <div class="opacity" style="z-index:9993;"></div>
        <div class="content" style="width:1000px;margin-left:-500px;z-index:9994;">
            <a class="close"></a>
            <h1>结项</h1>
            <div class="d_zql clearfix">
                <label>预警准确率</label>
                <p><span><a></a><a></a><a></a><a></a><a></a></span></p>
            </div>
            <h1 style="text-align:center;margin:15px 20px 0;">结项备注</h1>
            <div style="margin:0px 20px;"><textarea class="remark"></textarea></div>

            <div class="btn">
                <button type="button" class="cancle" onclick="$('#jx_detail_form').hide()">关闭</button>
                <button type="button" class="ml15 submitBtn">我要结项</button>
            </div>
        </div>
    </div>
	<script>
	var start = {
	  elem: '#beginDate',
	  format: 'YYYY-MM-DD',
	  choose: function(datas){
		 end.min = datas; //开始日选好后，重置结束日的最小日期
		 end.start = datas //将结束日的初始值设定为开始日
	  }
	};
	var end = {
	  elem: '#endDate',
	  format: 'YYYY-MM-DD',
	  choose: function(datas){
		start.max = datas; //结束日选好后，重置开始日的最大日期
	  }
	};
	laydate(start);
	laydate(end);

	var sourceData = 1; //1是审核派工 2是执行结果

	$(function () {
	    $(".row_1 .btn_b a").click(function () {

	        //清空数据
	        $(".row_2 .table_1 .grid tbody tr").remove();
	        $("#page").html('');

	        $(this).addClass("active").siblings().removeClass("active");
	        if ($(this).hasClass('a1')) {
	            $(".chart_1").show();
	            $(".chart_2").hide();
	            $(".row_3 .table_1").show();
	            $(".row_3 .table_3").hide();
	            sourceData = 1;
	        } else {
	            $(".chart_2").show();
	            $(".chart_1").hide();
	            $(".row_3 .table_1").hide();
	            $(".row_3 .table_3").show();
	            sourceData = 2;
	        }

	        loadPage(1)
	    })
	    if (getQueryString('op') != ""){
	        localStorage.setItem('keyone', 1);
			localStorage.setItem('keytwo', 0);
		}
	    if (getQueryString('op') == '2') {
	        $(".row_1 .btn_b a:eq(1)").trigger("click");
	        sourceData = 2;

	    } else {
	        sourceData = 1;
	    }
	    //载入数据
	    LoginJFPage(function () {

	        LoginPage();
	        //图表
	        loadPage(1);
	        loadTimePage(0);

	        chart_1();
	        chart_2();
	    })

	    $(".row_3 .table_1 a:eq(0)").click(function () {
	        if ($(".table_1 .grid input[type='radio']:checked").length == 0) {
	            alert('请选择要回退的数据！');
	            return;
	        }
	        if ($(".table_1 .grid input[type='radio']:checked:eq(0)").attr("state") != '2') {
	            alert('只有状态为【待派工】的数据才可以回退！');
	            return;
	        }
	        $("#dialog_1 .submitBtn").attr("alarmid", $(".table_1 .grid input[type='radio']:checked:eq(0)").attr("alarmid"));
	        $("#dialog_1").show();
	    })

	    //工单详情 结项
	    $(".gd_detail h1 span:eq(0)").click(function () {
	        openjxDetail(currRow.index())
	    })

	    //工单详情 审核回退
	    $(".gd_detail h1 span:eq(1)").click(function () {
	        $("#dialog_1 .submitBtn").attr("alarmid", currRow.find("input[type='radio']").attr("alarmid"));
	        $("#dialog_1").show();
	    })

	    $(".row_3 .table_1 a:eq(2)").click(function () {
	        $("#dialog_2").show();
	        if ($("#addwfName option").length <= 1) {
	            //绑定风场名称
	            layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 999999 });
	            $.ajax({
	                type: "post",
	                url: window.JFApiDomian + '/alarmInfo_getWfName.do',
	                cache: false,
	                dataType: 'jsonp',
	                xhrFields: {
	                    withCredentials: true
	                },
	                crossDomain: true,
	                complete: function () {
	                    layer.closeAll();
	                },
	                success: function (json) {
	                    for (var o in json.listData) {
	                        $("#addwfName").append('<option value="' + json.listData[o].wfid + '">' + json.listData[o].wfName + '</option>');
	                    }
	                },
	                error: function () {
	                    alert('载入数据失败！');
	                }
	            });
	        }
	        if ($("#addYhd option").length <= 1) {
	            initYhd();
	        }
	    })
	    $(".row_3 .table_1 a:eq(1)").click(function () {
	        if ($(".table_1 .grid input[type='radio']:checked").length == 0) {
	            alert('请选择要派工的数据！');
	            return;
	        }
	        if ($(".table_1 .grid input[type='radio']:checked:eq(0)").attr("state") != '2') {
	            alert('只有状态为【待派工】的数据才可以派工！');
	            return;
	        }
	        $("#dialog_3 .submitBtn").attr("alarmid", $(".table_1 .grid input[type='radio']:checked:eq(0)").attr("alarmid"));
	        var curIndex = $(".table_1 .grid input[type='radio']:checked").parent().parent().index();
	        //载入数据
	        $("#pg_yjTime").val(getjfLocalTime(currPageJson.pagination.list[curIndex].beginTime.time));
	        $("#pg_wfName").html('<option>' + currPageJson.pagination.list[curIndex].wfName + '</option>');
	        $("#pg_wtName").html('<option>' + currPageJson.pagination.list[curIndex].wtName + '</option>');
	        $("#pg_yhd").html('<option>' + currPageJson.pagination.list[curIndex].alarmName_CN + '</option>');
	        $("#pg_level").html('<option>' + currPageJson.pagination.list[curIndex].alarmGrade_CN + '</option>');
	        $("#pg_remark").val(currPageJson.pagination.list[curIndex].remark);
	        $("#pg_wtid").val(currPageJson.pagination.list[curIndex].wtID);
	        $("#pg_workID").val(CreateWorkID(currPageJson.pagination.list[curIndex].wtID));

	        switch (currPageJson.pagination.list[curIndex].dataType) {
	            case 1:
	                $("#pg_source").html('<option>巡检发现异常</option>');
	                break;
                case 2:
                    $("#pg_source").html('<option>生产系统预警</option>');
                    break;
                case 3:
                    $("#pg_source").html('<option>检测报告预警</option>');
                    break;
	            default:
	                $("#pg_source").html('<option>金风智能预警</option>');
	                break;
	        }
	        $("#dialog_3").show();
	        //执行单编号
	    })
        //工单详情 派工
	    $(".gd_detail h1 span:eq(2)").click(function () {
	        $("#dialog_3 .submitBtn").attr("alarmid", currRow.find("input[type='radio']").attr("alarmid"));
	        var curIndex = currRow.index();
	        //载入数据
	        $("#pg_yjTime").val(getjfLocalTime(currPageJson.pagination.list[curIndex].beginTime.time));
	        $("#pg_wfName").html('<option>' + currPageJson.pagination.list[curIndex].wfName + '</option>');
	        $("#pg_wtName").html('<option>' + currPageJson.pagination.list[curIndex].wtName + '</option>');
	        $("#pg_yhd").html('<option>' + currPageJson.pagination.list[curIndex].alarmName_CN + '</option>');
	        $("#pg_level").html('<option>' + currPageJson.pagination.list[curIndex].alarmGrade_CN + '</option>');
	        $("#pg_remark").val(currPageJson.pagination.list[curIndex].remark);
	        $("#pg_wtid").val(currPageJson.pagination.list[curIndex].wtID);
	        $("#pg_workID").val(CreateWorkID(currPageJson.pagination.list[curIndex].wtID));
	        switch (currPageJson.pagination.list[curIndex].dataType) {
	            case 1:
	                $("#pg_source").html('<option>巡检发现异常</option>');
	                break;
	            case 2:
	                $("#pg_source").html('<option>生产系统预警</option>');
	                break;
	            case 3:
	                $("#pg_source").html('<option>检测报告预警</option>');
	                break;
	            default:
	                $("#pg_source").html('<option>金风智能预警</option>');
	                break;
	        }
	        $("#dialog_3").show();
	    })
	    $(".row_3 .table_2 a:eq(1)").click(function () {
	        $("#dialog_4").show();
	        if ($("#subwfName option").length == 0) {
	            //绑定风场名称
	            layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 999999 });
	            $.ajax({
	                type: "post",
	                url: window.JFApiDomian + '/alarmInfo_getWfName.do',
	                cache: false,
	                dataType: 'jsonp',
	                xhrFields: {
	                    withCredentials: true
	                },
	                crossDomain: true,
	                complete: function () {
	                    layer.closeAll();
	                },
	                success: function (json) {
	                    for (var o in json.listData) {
	                        $("#subwfName").append('<option value="' + json.listData[o].wfid + '">' + json.listData[o].wfName + '</option>');
	                    }
	                },
	                error: function () {
	                    alert('载入数据失败！');
	                }
	            });
	        }
	    })
	    $(".row_3 .table_3 a").click(function () {
	        //结项
	        if ($(".table_1 .grid input[type='radio']:checked").length == 0) {
	            alert('请选择要【结项】的数据！');
	            return;
	        }
	        if ($(".table_1 .grid input[type='radio']:checked:eq(0)").attr("state") != '3') {
	            alert('只有状态为【已派工】的数据才可以派工！');
	            return;
	        }
	        var index = $(".table_1 .grid input[type='radio']:checked").parent().parent().index();

	        openjxDetail(index);
	    })

	    $("#jx_detail_form .d_zql a").click(function () {
	        $("#jx_detail_form .d_zql a").removeClass("active");
	        $("#jx_detail_form .d_zql a").slice(0, $(this).index() + 1).addClass("active");
	    })

	    //新增预警
	    $("#dialog_2 .submitBtn").click(function () {
	        if (!Validator.Validate(document.getElementById('add_form'))) return false;
	        var load = layer.msg('数据提交中...', { icon: 16, shade: 0.01, time: 999999 });

	        var data = 'dataType=' + $("#addsource").val() + '&wfID=' + $("#addwfName").val() + '&publishUser=' + userId + '&adder=' + userId
                + '&wfName=' + $("#addwfName").find("option:selected").text() + '&wtName=' + $("#addwtName").find("option:selected").text()
                + '&wtID=' + $("#addwtName").val() + '&ruleID=' + $("#addYhd").val() + '&wfStep=1&wfState=3&isRight=0&remark=' + $("#addremark").val()
                + '&workID=' + CreateWorkID($("#addwtName").val());
	        
	        $.ajax({
	            type: "post",
	            url: window.JFApiDomian + '/alarmInfo_addAlarmInfo.do',
	            cache: false,
	            data: data,
	            dataType: 'jsonp',
	            xhrFields: {
	                withCredentials: true
	            },
	            crossDomain: true,
	            complete: function () {
	                layer.close(load);
	            },
	            success: function (json) {
	                layer.msg(json.message, { time: 1000 }, function () {
	                    $("#dialog_2").hide();
	                    if (json.state == 1) {
	                        //清空表单
	                        $("#add_form").get(0).reset();

	                        //重新生成图表
	                        chart_1();
	                        chart_2();

	                        loadPage(parseInt($("#page a.activP").text()));
	                    }
	                });
	            },
	            error: function () {
	                alert('数据提交失败！');
	            }
	        });
	    })
	    $("#dialog_4 .submitBtn").click(function () {
	        if (!Validator.Validate(document.getElementById('subform'))) return false;

	        var json = ',"wfID":' + $("#subwfName").val();
	        json += ',"reportType":1';
	        json += ',"reportGrade":' + $("#sublevel").val();
	        json += ',"reportBeginTime":"' + $("#beginDate").val() + '"';
	        json += ',"reportEndTime":"' + $("#endDate").val() + '"';
	        json += ',"reportRemark":"' + $("#subremark").val() + '"';
	        json += ',"reportPath":"' + $("#hidfile").val() + '"';
	        json = '{' + json.substr(1) + '}';
	        layer.msg('数据提交中...', { icon: 16, shade: 0.01, time: 999999 });
	        $.ajax({
	            type: "post",
	            url: window.ApiDomian + '/report/add.json',
	            cache: false,
	            data: json,
	            contentType: "application/json; charset=utf-8",
	            dataType: 'json',
	            xhrFields: {
	                withCredentials: true
	            },
	            crossDomain: true,
	            complete: function () {
	                layer.closeAll();
	            },
	            success: function (jsondate) {
	                if (jsondate.state == 1) {
	                    $("#dialog_4").hide();
	                    layer.msg('数据提交成功', { time: 1000 }, function () {
	                        $("#subform").get(0).reset();
	                        //成功后刷新列表
	                        loadTimePage(parseInt($("#page_2 a.activS").text()) - 1);
	                    });
	                } else {
	                    alert(jsondate.message)
	                }
	            },
	            error: function () {
	                alert('数据提交失败！');
	            }
	        });
	    })
	})

	var currRow;

	function getSphmTime(alarmID) {

	    var index = layer.msg('数据获取中...', { icon: 16, shade: 0.01, time: 999999 });
	    //获取SPHM收到预警时间
	    $.ajax({
	        type: "post",
	        url: window.JFApiDomian + '/alarmInfo_getAlarmMsg.do?alarmID=' + alarmID,
	        cache: false,
	        async: true,
	        dataType: 'jsonp',
	        xhrFields: {
	            withCredentials: true
	        },
	        crossDomain: true,
	        complete: function () {
	            layer.close(index);
	        },
	        success: function (json) {
	            if (json.listData.length > 0) {
	                return '无';
	            }
	            return '无';
	        },
	        error: function () {
	            alert('载入数据失败！');
	        }
	    });
    }

	function clickDetail() {
	    $(".grid tr").on("dblclick", function (event) {
	        var checkbox = $(this).find("input[type='radio']");
	        var _id = checkbox.val();
	        currRow = $(this);
	        var Index = currRow.index();
	        if (checkbox.attr("state") == '2') {
	            $(".gd_detail h1 span:eq(1),.gd_detail h1 span:eq(2)").show();
	        } else {
	            $(".gd_detail h1 span:eq(1),.gd_detail h1 span:eq(2)").hide();
	        }
	        if (checkbox.attr("state") == '3') {
	            $(".gd_detail h1 span:eq(0)").show();
	        } else {
	            $(".gd_detail h1 span:eq(0)").hide();
	        }
	        //工单编号
	        var workID, proTime, areaName, time;
	        if (sourceData == 2) {
	            workID = currPageJson.pagination.list[Index].workID == undefined ? "&nbsp;" : currPageJson.pagination.list[Index].workID;
	            proTime = getjfLocalTime(currPageJson.pagination.list[Index].proTime.time);
	            areaName = currPageJson.pagination.list[Index].proName;
	        } else {
	            areaName = currPageJson.pagination.list[Index].regionname;
	            proTime = '&nbsp;';
	            workID = '派工后生成';
	        }

	        $(".gd_detail h1 label").html('工单编号：'+workID);
	        switch (currPageJson.pagination.list[Index].wfState) {
	            case 1:
	                $(".gd_detail .wrap:eq(0) span:eq(0)").text('回退');
	                $(".gd_detail .wrap:eq(0) span:eq(1)").text('处理完成');
	                break;
	            case 2:
	                $(".gd_detail .wrap:eq(0) span:eq(0)").text('待派工');
	                $(".gd_detail .wrap:eq(0) span:eq(1)").text('处理中');
	                break;
	            case 3:
	                $(".gd_detail .wrap:eq(0) span:eq(0)").text('已派工');
	                $(".gd_detail .wrap:eq(0) span:eq(1)").text('处理中');
	                break;
	            case 4:
	                $(".gd_detail .wrap:eq(0) span:eq(0)").text('已结项');
	                $(".gd_detail .wrap:eq(0) span:eq(1)").text('处理完成');
	                break;
	            default:
	                $(".gd_detail .wrap:eq(0) span:eq(0)").text('待审核');
	                $(".gd_detail .wrap:eq(0) span:eq(1)").text('未处理');
	                break;
	        }
	        $(".gd_detail .wrap:eq(0) span:eq(2)").text(currPageJson.pagination.list[Index].alarmName_CN);
	        $(".gd_detail .wrap:eq(0) span:eq(3)").text(currPageJson.pagination.list[Index].alarmGrade_CN);
	        $(".gd_detail .wrap:eq(1) span:eq(0)").text(areaName);
	        $(".gd_detail .wrap:eq(1) span:eq(1)").text(currPageJson.pagination.list[Index].wfName);
	        $(".gd_detail .wrap:eq(1) span:eq(2)").text(currPageJson.pagination.list[Index].wtName);
	        $(".gd_detail .wrap:eq(1) span:eq(3)").text(getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time));
	        $(".gd_detail .wrap:eq(2) span:eq(0)").html(proTime);
	        $(".gd_detail .wrap:eq(2) span:eq(1)").html("&nbsp;");
	        switch (currPageJson.pagination.list[Index].isRight) {
	            case 1:
	            case 2:
	                $(".gd_detail .wrap:eq(2) span:eq(2) p").html('<a></a>');
	                break;
	            case 3:
	            case 4:
	                $(".gd_detail .wrap:eq(2) span:eq(2) p").html('<a></a><a></a>');
	                break;
	            case 5:
	            case 6:
	                $(".gd_detail .wrap:eq(2) span:eq(2) p").html('<a></a><a></a><a></a>');
	                break;
	            case 7:
	            case 8:
	                $(".gd_detail .wrap:eq(2) span:eq(2) p").html('<a></a><a></a><a></a><a></a>');
	                break;
	            case 9:
	            case 10:
	                $(".gd_detail .wrap:eq(2) span:eq(2) p").html('<a></a><a></a><a></a><a></a><a></a>');
	                break;
	            default:
	                $(".gd_detail .wrap:eq(2) span:eq(2) p").html('&nbsp;');
	                break;
	        }
	        $(".gd_detail .wrap:eq(3) .mul_text").text(currPageJson.pagination.list[Index].proContent == undefined ? "" : currPageJson.pagination.list[Index].proContent);
	        

	        $(".liucheng .wrap").remove();

	        var messageType = currPageJson.pagination.list[Index].messageType == undefined ? 1 : currPageJson.pagination.list[Index].messageType;
	        
	        if (messageType == 0)
	            $(".gd_detail .wrap:eq(4) .mul_text").html("&nbsp;");
	        else
	            $(".gd_detail .wrap:eq(4) .mul_text").text(currPageJson.pagination.list[Index].plan_CN);

	        //流程
	        if (currPageJson.pagination.list[Index].wfState == 2 || currPageJson.pagination.list[Index].wfState == 0) {
	            //预警
	            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">生成预警</label></div>');
	            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">推荐处理方案</label><div class="mul_text">' + currPageJson.pagination.list[Index].plan_CN + '</div></div>');
	            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>SPHM收到预警</label></div>');

	        }
	        if (currPageJson.pagination.list[Index].wfState == 1) {
	            
	            if (messageType == 1)
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">生成预警</label></div>');
	            else
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>生成预警</label><div class="mul_text"><p>操作人：' + currPageJson.pagination.list[Index].publishUser + '</p><p>备注：' + (currPageJson.pagination.list[Index].proContent == undefined ? "" : currPageJson.pagination.list[Index].proContent) + '</p></div></div>');

	            if (messageType == 1)
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">推荐处理方案</label><div class="mul_text">' + currPageJson.pagination.list[Index].plan_CN + '</div></div>');

	            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>SPHM收到预警</label></div>');
	            
	            var index = layer.msg('数据获取中...', { icon: 16, shade: 0.01, time: 999999 });
	            $.ajax({
	                type: "post",
	                url: window.JFApiDomian + '/alarmInfo_getAlarmFallback.do?alarmID=' + currPageJson.pagination.list[Index].alarmID,
	                cache: false,
	                dataType: 'jsonp',
	                xhrFields: {
	                    withCredentials: true
	                },
	                crossDomain: true,
	                complete: function () {
	                    layer.close(index)
	                },
	                success: function (json) {
	                    //审核回退
	                    $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].verifyTime.time) + '</label> <label>审核回退</label><div class="mul_text"><p>操作时间：' + getjfLocalTime(json.listData[0].addTime.time) + '</p><p>操作人：' + json.listData[0].sender + '</p><p>备注：' + (json.listData[0].reason == undefined ? "无" : json.listData[0].reason) + '</p></div></div>');
	                },
	                error: function () {
	                    alert('载入数据失败！');
	                }
	            });
	        }

	        //已派工
	        if (currPageJson.pagination.list[Index].wfState == 3) {

	            if (messageType == 1)
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">生成预警</label></div>');
	            else
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>生成预警</label><div class="mul_text"><p>操作人：' + currPageJson.pagination.list[Index].publishUser + '</p><p>备注：' + (currPageJson.pagination.list[Index].proContent == undefined ? "" : currPageJson.pagination.list[Index].proContent) + '</p></div></div>');

                if(messageType == 1)
                    $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">推荐处理方案</label><div class="mul_text">' + currPageJson.pagination.list[Index].plan_CN + '</div></div>');

	            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>SPHM收到预警</label></div>');

	            var index = layer.msg('数据获取中...', { icon: 16, shade: 0.01, time: 999999 });
	            //获取派工的基本信息
	            $.ajax({
	                type: "post",
	                url: window.JFApiDomian + '/alarmInfo_getAlarmWork.do?customAlarmID=' + currPageJson.pagination.list[Index].customAlarmID,
	                cache: false,
	                dataType: 'jsonp',
	                xhrFields: {
	                    withCredentials: true
	                },
	                crossDomain: true,
	                success: function (json) {
	                    var workHtml = '';
	                    for (var i = 0; i < json.listData[0].works.length; i++) {
	                        if (i == 0)
	                            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(json.listData[0].works[i].proTime.time) + '</label> <label>开始派工</label><div class="mul_text"><p>预警工单编号：' + json.listData[0].works[i].workID + '</p><p>操作人：' + (messageType == 1 ? "自动生成" : currPageJson.pagination.list[Index].publishUser) + '</p><p>备注：' + (json.listData[0].works[i].proContent == undefined ? "无" : json.listData[0].works[i].proContent) + '</p></div></div>');
	                        else {
	                            if (i == 1)
	                                workHtml = '<div class="wrap"><i></i><label>&nbsp;</label> <label>执行单记录</label>';

	                            workHtml += '<div class="mul_text">'
	                            workHtml += '<p>执行单ID：' + json.listData[0].works[i].workID + '</p>'
	                            workHtml += '<p>创建时间：' + getjfLocalTime(json.listData[0].works[i].addTime.time) + '</p>'
	                            workHtml += '<p>创建人：' + json.listData[0].works[i].adder + '</p>'
	                            workHtml += '<p>处理人：' + json.listData[0].works[i].proer + '</p>'
	                            workHtml += '<p>备注：' + (json.listData[0].works[i].proContent == undefined ? "无" : json.listData[0].works[i].proContent) + '</p>'
	                            var isRight = json.listData[0].works[i].isRight || 0;

	                            workHtml += '<p>准确率判断：' + (isRight == 1 ? "准确" : "不准确") + '</p>';

	                            var bjdetail = '';
	                            //获取部件
	                            for (var j = 0; j < json.listData[0].parts.length; j++) {
	                                if (json.listData[0].parts[j].workID == json.listData[0].works[i].workID && json.listData[0].parts[j].customAlarmID == currPageJson.pagination.list[Index].customAlarmID) {
	                                    bjdetail += '<p>部件名称：' + json.listData[0].parts[j].partName + ' X ' + json.listData[0].parts[j].partNum + '</p>';
	                                }
	                            }
	                            if (bjdetail == '') {
	                                workHtml += '<p>是否更换部件：否</p>';
	                            } else
	                                workHtml += '<p>是否更换部件：是</p>';

	                            workHtml += bjdetail;

	                            workHtml += '</div>';

	                            //列出执行单
	                            if (i == json.listData[0].works.length - 1)
	                                workHtml += '</div>';
	                        }
	                    }

	                    $(".liucheng").append(workHtml);

	                    if (json.listData[0].works.length > 1) {
	                        $(".gd_detail .wrap:eq(2) span:eq(1)").html(currPageJson.pagination.list[Index].customAlarmID == null ? "&nbsp;" : ('<a class="blue" onclick="openjxDetail(' + Index + ')">查看结果</a>'));
	                    }

	                    layer.close(index);
	                },
	                error: function () {
	                    layer.close(index);
	                    alert('载入数据失败！');
	                }
	            });
	        }

	        //已结项
	        if (currPageJson.pagination.list[Index].wfState == 4) {
	            if (messageType == 1)
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">生成预警</label></div>');
	            else
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>生成预警</label><div class="mul_text"><p>操作人：' + currPageJson.pagination.list[Index].publishUser + '</p><p>备注：' + (currPageJson.pagination.list[Index].proContent == undefined ? "" : currPageJson.pagination.list[Index].proContent) + '</p></div></div>');

	            if (messageType == 1)
	                $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label class="yellow">推荐处理方案</label><div class="mul_text">' + currPageJson.pagination.list[Index].plan_CN + '</div></div>');

	            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].beginTime.time) + '</label> <label>SPHM收到预警</label></div>');

	            var index = layer.msg('数据获取中...', { icon: 16, shade: 0.01, time: 999999 });
	            //获取派工的基本信息
	            $.ajax({
	                type: "post",
	                url: window.JFApiDomian + '/alarmInfo_getAlarmWork.do?customAlarmID=' + currPageJson.pagination.list[Index].customAlarmID,
	                cache: false,
	                dataType: 'jsonp',
	                xhrFields: {
	                    withCredentials: true
	                },
	                crossDomain: true,
	                success: function (json) {
	                    var workHtml = '';
	                    for (var i = 0; i < json.listData[0].works.length; i++) {
	                        if (i == 0)
	                            $(".liucheng").append('<div class="wrap"><i></i><label>' + getjfLocalTime(json.listData[0].works[i].proTime.time) + '</label> <label>开始派工</label><div class="mul_text"><p>预警工单编号：' + json.listData[0].works[i].workID + '</p><p>操作人：' + (messageType == 1 ? "自动生成" : currPageJson.pagination.list[Index].publishUser) + '</p><p>备注：' + (json.listData[0].works[i].proContent == undefined ? "无" : json.listData[0].works[i].proContent) + '</p></div></div>');
	                        else {
	                            if (i == 1)
	                                workHtml = '<div class="wrap"><i></i><label>&nbsp;</label> <label>执行单记录</label>';

	                            workHtml += '<div class="mul_text">'
	                            workHtml += '<p>执行单ID：' + json.listData[0].works[i].workID + '</p>'
	                            workHtml += '<p>创建时间：' + getjfLocalTime(json.listData[0].works[i].addTime.time) + '</p>'
	                            workHtml += '<p>创建人：' + json.listData[0].works[i].adder + '</p>'
	                            workHtml += '<p>处理人：' + json.listData[0].works[i].proer + '</p>'
	                            workHtml += '<p>备注：' + (json.listData[0].works[i].proContent == undefined ? "无" : json.listData[0].works[i].proContent) + '</p>'
	                            var isRight = json.listData[0].works[i].isRight || 0;

	                            workHtml += '<p>准确率判断：' + (isRight == 1 ? "准确" : "不准确") + '</p>'
	                            //获取部件
	                            var bjdetail = '';
	                            for (var j = 0; j < json.listData[0].parts.length; j++) {
	                                if (json.listData[0].parts[j].workID == json.listData[0].works[i].workID && json.listData[0].parts[j].customAlarmID == currPageJson.pagination.list[Index].customAlarmID) {
	                                    bjdetail += '<p>部件名称：' + json.listData[0].parts[j].partName + ' X ' + json.listData[0].parts[j].partNum + '</p>';
	                                }
	                            }

	                            if (bjdetail == '') {
	                                workHtml += '<p>是否更换部件：否</p>';
	                            } else
	                                workHtml += '<p>是否更换部件：是</p>';
	                            workHtml += '</div>';
	                            //列出执行单
	                            if (i == json.listData[0].works.length - 1)
	                                workHtml += '</div>';
	                        }
	                    }
	                    $(".gd_detail .wrap:eq(2) span:eq(1)").html(currPageJson.pagination.list[Index].customAlarmID == null ? "&nbsp;" : ('<a class="blue" onclick="openjxDetail(' + Index + ')">查看结果</a>'));
	                    $(".liucheng").append(workHtml);

	                    var html = '<div class="wrap"><i></i><label>' + getjfLocalTime(currPageJson.pagination.list[Index].overTime.time) + '</label> <label>完成结项</label><div class="mul_text"><p>结项时间：' + getjfLocalTime(currPageJson.pagination.list[Index].overTime.time)
                            + '</p><p>操作人：' + currPageJson.pagination.list[Index].overUser + '</p><p>预警准确率：';

	                    var isright = currPageJson.pagination.list[Index].isRight || 0;
	                    switch (isright) {
	                        case 1:
	                        case 2:
	                            html += '1星';
	                            break;
	                        case 3:
	                        case 4:
	                            html += '2星';
	                            break;
	                        case 5:
	                        case 6:
	                            html += '3星';
	                            break;
	                        case 7:
	                        case 8:
	                            html += '4星';
	                            break;
	                        case 9:
	                        case 10:
	                            html += '5星';
	                            break;
	                        default:
	                            html += '&nbsp;';
	                            break;
	                    }

	                    html += '</p><p>备注：' + (currPageJson.pagination.list[Index].remark == undefined ? "无" : currPageJson.pagination.list[Index].remark) + '</p></div></div>';

	                    $(".liucheng").append(html);
	                    layer.close(index);
	                },
	                error: function () {
	                    layer.close(index);
	                    alert('载入数据失败！');
	                }
	            });
	        }

	        $(".gd_detail").show();
	        event.stopPropagation();
	    })
    }

    var currPageJson;
	function loadPage(pageIndex) {
	    var page_layer = layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 999999 });

	    var url = window.JFApiDomian + '/alarmInfo_searchWorkBeg.do?pageid=' + pageIndex + '&pagecount=10&wfState=2&userId=' + userId + getFilter();
	    if (sourceData == 2)
	        url = window.JFApiDomian + '/alarmInfo_searchWorkPub.do?pageid=' + pageIndex + '&pagecount=10&wfState=1,3,4&userId=' + userId + getFilter();

	    $.ajax({
	        type: "post",
	        url: url,
	        cache: false,
	        dataType: 'jsonp',
	        xhrFields: {
	            withCredentials: true
	        },
	        crossDomain: true,
	        success: function (json) {
	            if (pageIndex == json.pagination.pageNo) {
	                currPageJson = json;
	                $(".row_2 .table_1 .grid tbody tr").remove();
	                var html = '';
	                var lc = '';
	                var jsonList = json.pagination.list;
	                var messageType;
	                for (var o in jsonList) {
	                    lc = '';

	                    if (jsonList[o].messageType == undefined)
	                        messageType = 1;
                        else
	                        messageType = jsonList[o].messageType;

	                    html = '<tr><td><input type="radio" value="1" customAlarmId="' + jsonList[o].customAlarmID+ '" alarmID="' + jsonList[o].alarmID + '" state="' + jsonList[o].wfState + '" class="chk" name="chk" /></td>'
                            + '<td>' + getjfLocalTime(jsonList[o].beginTime.time) + '</td><td>' + (sourceData == 1 ? jsonList[o].regionname : jsonList[o].proName) + '</td><td>' + jsonList[o].wfName + '</td>'
                            + '<td>' + jsonList[o].wtName + '</td><td>' + jsonList[o].alarmName_CN + '</td><td>' + jsonList[o].alarmGrade_CN + '</td>'
                            + '<td title="' + (messageType == 1 ? jsonList[o].plan_CN : "") + '">' + (messageType == 1 ? sb_substr(jsonList[o].plan_CN, 0, 30) : "") + '</td><td>';
	                    switch (jsonList[o].wfState) {
	                        case 0:
	                            html += '待审核';
	                            lc = '未处理';
	                            break;
	                        case 1:
	                            html += '回退';
	                            lc = '处理完成';
	                            break;
	                        case 2:
	                            html += '待派工';
	                            lc = '处理中';
	                            break;
	                        case 3:
	                            html += '已派工';
	                            lc = '处理中';
	                            break;
	                        case 4:
	                            html += '结项';
	                            lc = '处理完成';
	                            break;
	                        default:
	                            html += '&nbsp;';
	                            break;
	                    }
	                    html += '</td><td>' + lc + '</td></tr>';

	                    $(".row_2 .table_1 .grid tbody").append(html);
	                }

	                bindRowBgColor();
	                clickDetail();
	            }
	            if ($("#page").text() == '') {
	                $("#page").Page({
	                    totalPages: json.pagination.totalPage,
	                    liNums: 7,
	                    firstPage: '首页',
	                    lastPage: '末页',
	                    hasPrv: true,
	                    hasNext: true,
	                    activeClass: 'activP',
	                    callBack: function (page) {
	                        loadPage(page);
	                    }
	                });
	            }
	            layer.close(page_layer);
	        },
	        error: function () {
	            layer.close(page_layer);
	            //alert('载入数据失败！');
	        }
	    });
	}

	function getFilter() {
	    
	    return "";
    }

    function loadTimePage(pageIndex) {
        pageLayer = layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 999999 });
        $.ajax({
            type: "post",
            url: window.ApiDomian + '/report/list.json?page=' + (pageIndex) + '&size=10',
            cache: false,
            dataType: 'json',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (json) {
                if (json.state == 1 && json.pagination.pageNo == (pageIndex + 1)) {
                    $(".table_2 .grid tbody tr").remove();
                    
                    if (json.data.reportGrade == 2) {
                        $(".yj_index .cms .logo").css("background-image", "url(images/2c1.png)");
                    } else if (json.data.reportGrade == 1) {
                        $(".yj_index .cms .logo").css("background-image", "url(images/2c2.png)");
                    }
                    var jsonList = json.pagination.list;
                    for (var o in jsonList) {
                        var html = '<tr class="';
                        switch (jsonList[o].reportGrade) {
                            case 0:
                                html += '';
                                break;
                            case 1:
                                html += 'yellow';
                                break;
                            case 2:
                                html += 'red';
                                break;
                        }
                        html += '"><td>2016-01-02 20:33</td><td>';
                        switch (jsonList[o].reportGrade) {
                            case 0:
                                html += '正常';
                                break;
                            case 1:
                                html += '预警';
                                break;
                            case 2:
                                html += '报警';
                                break;
                        }
                        html += '</td></tr>';

                        $(".table_2 .grid tbody").append(html);
                    }
                    bindRowBgColor();
                    
                    if ($("#page_2").text() == '') {
                        $("#page_2").Page({
                            totalPages: json.pagination.totalPage, //分页总数
                            liNums: 3, //分页的数字按钮数(建议取奇数)
                            activeClass: 'activS', //active 类样式定义
                            firstPage: '<<',
                            lastPage: '>>',
                            hasPrv: false,
                            hasNext: false,
                            initPage: loadTimePage,
                            call: function (page) {
                                loadTimePage(page - 1)
                            }
                        });
                    }
                }
                layer.close(pageLayer);
            },
            error: function () {
                layer.close(pageLayer);
                //alert('载入数据失败！');
            }
        });
	}

	function bindWT(to,o) {
	    var lay = layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 999999 });
	    $.ajax({
	        type: "post",
	        url: window.JFApiDomian + '/alarmInfo_getWtIDOrName.do?wfID=' + $(o).val()+"&userId="+userId,
	        cache: false,
	        dataType: 'jsonp',
	        xhrFields: {
	            withCredentials: true
	        },
	        crossDomain: true,
	        complete: function () {
	            layer.close(lay);
	        },
	        success: function (json) {
	            $(to).html('');
	            $(to).append('<option value="">请选择</option>');
	            for (var i = 0; i < json.listData.length; i++) {
	                $(to).append('<option value="' + json.listData[i].wtID + '">' + json.listData[i].wtName + '</option>');
	            }

	        },
	        error: function () {
	            alert('载入数据失败！');
	        }
	    });
	}

	//隐患点
	var yhjson;
	function initYhd() {
	    var index = layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 9999999999 });
	    $.ajax({
	        type: "post",
	        url: window.JFApiDomian + '/alarmInfo_getAlarmFileLevel.action',
	        cache: false,
	        dataType: 'jsonp',
	        xhrFields: {
	            withCredentials: true
	        },
	        crossDomain: true,
	        complete: function () {
	            layer.close(index);
	        },
	        success: function (json) {
	            yhjson = json.listData;
	            for (var o in yhjson) {
	                $("#addYhd").append('<option value="' + yhjson[o].ruleID + '">' + yhjson[o].alarmName_CN + '</option>');
	            }
	        },
	        error: function () {
	            alert('载入数据失败！');
	        }
	    });
	}
	//隐患级别
	function bindYhLevel(obj) {
	    if (yhjson == undefined) {
	        alert('没有获取到隐患级别');
	        return;
	    }
	    for (var o in yhjson) {
	        if (yhjson[o].ruleID == $(obj).val()) {
	            $("#addLevel").html('<option>' + yhjson[o].grade + '</option>');
                break;
            }
        }
    }

    //审核回退
    function huitui(from) {
        var _id = $("#dialog_1 .submitBtn").attr('alarmid');
        if (!Validator.Validate(document.getElementById('ht_form'))) return false;

        var data = 'alarmID=' + _id + '&wfState=1&reson=' + $("#reason").val() + '&remark=' + $("#ht_remark").val();

        var load = layer.msg('数据提交中...', { icon: 16, shade: 0.01, time: 999999 });
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/alarmInfo_callBack.do',
            cache: false,
            data: data,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            complete: function () {
                layer.close(load);
            },
            success: function (json) {
                layer.msg(json.message, { time: 1000 }, function () {
                    $("#dialog_1").hide();
                    if (json.state == 1) {
                        $("#ht_form").get(0).reset();

                        //重新生成图表
                        chart_1();
                        chart_2();

                        loadPage(parseInt($("#page a.activP").text()));
                    }
                });
            },
            error: function () {
                alert('数据提交失败！');
            }
        });
    }

    //开始派工
    function paigong(from) {
        var _id = $("#dialog_3 .submitBtn").attr('alarmid');
        if (!Validator.Validate(document.getElementById('pg_form'))) return false;

        var data = 'alarmID=' + _id + '&workID=' + $("#pg_workID").val() + '&wfState=3&remark=' + $("#pg_remark").val()+"&adder="+userId+"&proer="+userId;
 
        var load = layer.msg('数据提交中...', { icon: 16, shade: 0.01, time: 999999 });
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/alarmInfo_dispatchWork.do',
            cache: false,
            data: data,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            complete: function () {
                layer.close(load);
            },
            success: function (json) {
                layer.msg(json.message, { time: 1000 }, function () {
                    $("#dialog_3").hide();
                    if (json.state == 1) {
                        //清空表单
                        $("#pg_form").get(0).reset();

                        //重新生成图表
                        chart_1();
                        chart_2();

                        loadPage(parseInt($("#page a.activP").text()));
                    } else {
                        //重新生成
                        $("#pg_workID").val(CreateWorkID($("#pg_wtid").val()));
                    }
                });
            },
            error: function () {
                alert('数据提交失败！');
            }
        });
    }

    //图标
    function chart_1() {
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/main_getAlarmInfo.action',
            cache: false,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (json) {
                var yAxisData = new Array();
                var seriesData = new Array();
                for (var o in json.listData) {
                    if (json.listData[o].name == '新增预警') {
                        yAxisData.push(json.listData[o].name);
                        seriesData.push(json.listData[o].data);
                    } else if (json.listData[o].name == '等级信息') {
                        for (var t in json.listData[o].data) {
                            yAxisData.push(json.listData[o].data[t].name);
                            seriesData.push(json.listData[o].data[t].data);
                        }
                    }
                }
                

                chart_1_1(yAxisData, seriesData);
            },
            error: function () {
                //alert('载入数据失败！');
            }
        });
    }
    //待审核 已审核 退回
    function chart_1_2(yAxisData, seriesData) {
        
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/main_getAlarmSupport.action',
            cache: false,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (json) {
                for (var o in json.listData) {
                    if (json.listData[o].name == '退回') {
                        yAxisData.push('回退');
                        seriesData.push(json.listData[o].data);
                    }
                }

                yAxisData.reverse();
                seriesData.reverse();
                option = BarOption_orientation('', yAxisData, '数量', seriesData)

                var myChart = echarts.init(document.getElementById('chart_1'));
                myChart.setOption(option);
                
            },
            error: function () {
                //alert('载入数据失败！');
            }
        });
    }

    function chart_1_1(yAxisData, seriesData) {
        var nyAxisData = new Array();
        var nseriesData = new Array();
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/main_getDispatchJob.action',
            cache: false,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (json) {
                for (var o in json.listData) {
                    if (json.listData[o].name == '待派工' || json.listData[o].name == '已派工') {
                        nyAxisData.push(json.listData[o].name);
                        nseriesData.push(json.listData[o].data);
                    }
                }
                
                for (var i = 0; i < yAxisData.length; i++) {
                    nyAxisData.push(yAxisData[i]);
                    nseriesData.push(seriesData[i]);
                }
                
                chart_1_2(nyAxisData, nseriesData);
                
            },
            error: function () {
                //alert('载入数据失败！');
            }
        });
    }

    function chart_2() {
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/main_getExecuteInfo.action',
            cache: false,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (json) {
                var yAxisData = new Array();
                var seriesData = new Array();
                for (var o in json.listData) {
                    if (json.listData[o].name == '已执行' || json.listData[o].name == '已结项') {
                        yAxisData.push(json.listData[o].name);
                        seriesData.push(json.listData[o].data);
                    }
                }
                yAxisData.reverse();
                seriesData.reverse();
                option = BarOption_orientation('', yAxisData, '数量', seriesData)

                var myChart = echarts.init(document.getElementById('chart_2'));
                myChart.setOption(option);
            },
            error: function () {
                alert('载入数据失败！');
            }
        });
    }

    function jx_layer() {
        $('#jx_detail_form .d_zql a').removeClass("active");
        $("#jx_detail_form textarea").val('');
        $('#jx_detail_form').show();
    }

    $('#jx_detail_form .submitBtn').click(function () {
        //获取星
        var isRight = $('#jx_detail_form .d_zql a.active').length * 2;
        var remark = $("#jx_detail_form textarea").val();
        var lay = layer.msg('结项提交中...', { icon: 16, shade: 0.01, time: 999999 });
        
        //提交结项
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/alarmInfo_setOverAlarm.do?alarmID=' + currPageJson.pagination.list[currRow.index()].alarmID + '&overUser=' + userId + "&wfState=4&isRight=" + isRight + "&remark=" + remark,
            cache: false,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            complete: function () {
                layer.close(lay);
            },
            success: function (json) {
                layer.msg(json.message, { time: 1000 }, function () {
                    if(json.state == 1){
                        $(".dialog").hide();
                        loadPage(parseInt($("#page a.activP").text()));
                    }
                });
            },
            error: function () {
                alert('载入数据失败！');
            }
        });
    })

    function openjxDetail(index) {
        var state = '';
        var lc = '';
        $("#jx_detail .submitBtn").unbind("click");
        $("#jx_detail .submitBtn").text("结项");
        switch (currPageJson.pagination.list[index].wfState) {
            case 1:
                state = "回退";
                lc = "处理完成";
                break;
            case 2:
                state = "待派工";
                lc = "处理中";
                break;
            case 3:
                state = "已派工";
                lc = "处理中";
                //绑定结项
                $("#jx_detail .submitBtn").click(function () {
                    jx_layer();
                })
                break;
            case 4:
                state = "已结项";
                lc = "处理完成";
                $("#jx_detail .submitBtn").text("已结项");
                break;
            default:
                state = "待审核";
                lc = "未处理";
                break;
        }

        $("#jx_detail .grid tbody").html("<tr><td>" + getjfLocalTime(currPageJson.pagination.list[index].beginTime.time) + "</td><td>" + (sourceData == 0 ? currPageJson.pagination.list[index].regionname : currPageJson.pagination.list[index].proName) + "</td><td>"
                + sb_substr(currPageJson.pagination.list[index].wfName,0,16) + "</td><td>" + currPageJson.pagination.list[index].wtName
                + "</td><td>" + currPageJson.pagination.list[index].alarmName_CN + "</td><td>" + currPageJson.pagination.list[index].alarmGrade_CN
                 + "</td><td>" + sb_substr(currPageJson.pagination.list[index].plan_CN, 0, 20) + "</td><td>" + state + "</td><td>" + lc + "</td></tr>")

        //结项信息
        if (currPageJson.pagination.list[index].wfState == 4) {

            var isRight = currPageJson.pagination.list[index].isRight || 0;
			$("#jx_detail .d_zql span").html('');
            if (isRight != 0) {
                for (var i = 0; i < isRight; i = i + 2)
                    $("#jx_detail .d_zql span").append("<a class='active'></a>");
            }
            $("#jx_detail textarea").val(currPageJson.pagination.list[index].remark);
            $("#jx_detail .hide").show();
        }
        else {
            $("#jx_detail .hide").hide();
        }

        //显示相关信息
        $("#scroll_h div").html('');
        layer.msg('数据载入中...', { icon: 16, shade: 0.01, time: 999999 });
        $.ajax({
            type: "post",
            url: window.JFApiDomian + '/alarmInfo_getAlarmWork.do?customAlarmID=' + currPageJson.pagination.list[index].customAlarmID,
            cache: false,
            dataType: 'jsonp',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (json) {
                var html, bjhtml, isBj, isRight;
                for (var i = 1; i < json.listData[0].works.length; i++) {
                    isBj = false;

                    html = '<div class="left_result"><h1>执行结果记录单_' + i + '</h1>';
                    html += '<dl class="clearfix"><dt>执行单ID</dt><dd><input type="text" value="' + json.listData[0].works[i].workID + '" class="txt" readonly></dd></dl>';
                    html += '<dl class="clearfix"><dt>创建时间</dt><dd><input type="text" value="' + getjfLocalTime(json.listData[0].works[i].addTime.time) + '" class="txt" readonly></dd></dl>';
                    html += '<dl class="clearfix"><dt>创建人</dt><dd><input type="text" value="' + json.listData[0].works[i].adder + '" class="txt" readonly></dd></dl>';
                    html += '<dl class="clearfix"><dt>处理人</dt><dd><input type="text" value="' + json.listData[0].works[i].proer + '" class="txt" readonly></dd></dl>';
                    html += '<dl class="clearfix"><dt>处理时间</dt><dd><input type="text" value="' + getjfLocalTime(json.listData[0].works[i].proTime.time) + '" class="txt" readonly></dd></dl>';

                    isRight = json.listData[0].works[i].isRight || 0;
                    if (isRight == 0)
                        html += '<dl class="clearfix"><dt>准确率判断</dt><dd>不准确</dd></dl>';
                    else
                        html += '<dl class="clearfix"><dt>准确率判断</dt><dd>准确</dd></dl>';
                    html += '<dl class="clearfix"><dt>备注</dt><dd><textarea name="remark" readonly="readonly" value="' + (json.listData[0].works[i].proContent == undefined ? "" : json.listData[0].works[i].proContent) + '"></textarea></dd></dl>';

                    bjhtml = '<div style="overflow:auto;height:100px;"><table cellpadding="0" cellspacing="0" border="0"><tr><td>备件名称</td><td>数量</td></tr>';

                    //获取部件
                    for (var j = 0; j < json.listData[0].parts.length; j++) {
                        if (json.listData[0].parts[j].workID == json.listData[0].works[i].workID && json.listData[0].parts[j].customAlarmID == currPageJson.pagination.list[Index].customAlarmID) {
                            isBj = true;
                            bjhtml += '<tr><td>' + json.listData[0].parts[j].partName + '</td><td>' + json.listData[0].parts[j].partNum + '</td></tr>';
                        }
                    }

                    bjhtml += '</table></div>';

                    if (isBj == true)
                        html += '<dl class="clearfix"><dt>是否更换部件</dt><dd>是</dd></dl>';
                    else
                        html += '<dl class="clearfix"><dt>是否更换部件</dt><dd>否</dd></dl>';

                    html += bjhtml;
                    html += '</div>';

                    $("#scroll_h > div").append(html);
                }

                $("#scroll_h .clearfix:eq(0)").css("width", json.listData[0].works.length * 460 + json.listData[0].works.length * 10);
                layer.closeAll();
            },
            error: function () {
                layer.closeAll();
                alert('载入数据失败！');
            }
        });

        $("#jx_detail").show();
    }
	</script>
</body>
</html>